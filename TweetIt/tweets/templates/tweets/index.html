{% extends 'tweets/base.html' %}
{% block content %}
<style>
    /* .row {
        background-color: #e6ecf0;
    } */
.tweet {
    border: 1px solid black;
    padding: 10px;
    margin: 10px;
    background-color: white;
}
#no-tweet {
    display: none;
}
</style>
<div class="row">


<div class="col-lg-3 col-sm-5">
        <div class="card mt-2" style="">
                <img class="card-img-top" src="{{ request.user.profile.image.url }}" alt="Card image cap">
                <div class="card-body">
                  <h5 class="card-title"><a href="/{{request.user.username}}">{{ request.user.username }}</a></h5>
                  <p class="card-text">{{ request.user.profile.description }}</p>
                </div>
                <div class="card-body">
                    
                  <a href="{% url 'tweet' %}" class="card-link">Tweets </a>
                  <a href="{% url 'user-follower' request.user.username %}" class="card-link ">Follower({{ request.user.followed_by.all.count }})</a>
                  <a href="{% url 'user-following' request.user.username %}" class="card-link ">Following({{ request.user.user_profile.following.all.count }})</a>
                </div>
        </div>
</div>
<div class="col-lg-7 col-sm-7">
    <div class="form-container mt-2 mb-2">
        <form action="" id="form" class="form" method="POST">
            {% csrf_token %}
            <textarea name="content" id="tweet-textarea" class="form-control mb-2" rows="5"></textarea>
            <button class="btn btn-primary">Tweet</button>
        </form>
    </div>
    <div class="card-footer text-muted text-center"><a href="">2 New Tweets</a></div>
    <div id="tweet-container">
        <p id="no-tweet">No tweets found</p>
    </div>
</div>
<div class="col-lg-2">
    <div class="mt-2"></div>
</div>
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Delete Tweet</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <form method="POST">{% csrf_token %}
            <div class="modal-body">
              Are you sure you want to delete?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <a type="button" class="btn btn-primary tweet-delete" href="" data-id="">Delete</a>
            </div>
         </form>
          </div>
        </div>
</div>
</div>
{% endblock content %}

{% block style %}
<script>
    $(document).ready(function(){
        var oldTweets = [];
        var newTweets = [];
        var tweets = [];
        console.log('Working');

        function updateHashLinks(){
            $(".media-content").each(function(data){
                var hashtagRegex = /(^|\s)#([\w\d-]+)/g
                var newText = $(this).html().replace(hashtagRegex,"$1<a href='/tags/$2/'>#$2</a>");
                $(this).html(newText);
            })
        }
        
        $(document.body).on("click",".tweet-delete",function(e){
            e.preventDefault();
            console.log("Delete Tweet..");
            var this_ = $(this);
            var tweetId = this_.attr('data-id');
            var deleteUrl = '/api/' + tweetId + "/delete/";
            $.ajax({
                method:"DELETE",
                url:deleteUrl,
                beforeSend:function(xhr){
                    xhr.setRequestHeader("X-CSRFToken",getCookie("csrftoken"))
                },
                success:function(data){
                    console.log(data);
                },
                error:function(data){
                    console.log("error");
                    console.log(data);
                }

            })
        })

        $(document.body).on("click",".tweet-like",function(e){
            e.preventDefault();
            var this_ = $(this);
            var tweetId = this_.attr('data-id');
            var likeUrl = 'api/' + tweetId + "/like/";
            $.ajax({
                method:"GET",
                url:likeUrl,
                success:function(data){
                    if(data.liked){
                        this_.text("Unlike")
                    } else {
                        this_.text("Like")
                    }
                },
                error:function(data){
                    console.log("error");
                    console.log(data);
                }
            })
        })

        $(document.body).on("click",".retweetBtn",function(e){
            e.preventDefault();
            console.log("Retweeting....");
            var url = "api/" + $(this).attr("href");
            console.log(url);
            $.ajax({
                method:"GET",
                url:url,
                success:function(data){
                    console.log(data);
                    createTweets(data,true,true);
                    updateHashLinks()
                },
                error:function(data){
                    console.log("error");
                    alert(data.responseJSON.message);
                    console.log(data);
                }
            })
        })

        function createTweets(tweet,prepend,retweet){
            console.log(tweet);
            var username = tweet.user.username;
            var tweetContent = tweet.content;
            var datePosted = tweet.date_posted;
            var profileImage = tweet.user.profile_image_url;
            var profileUrl = tweet.user.url;
            var parent = tweet.parent;
            var verb = "Like";
            var tweetFormattedHtml;
             if(tweet.is_liked){
                 verb = "Unlike"
             }
            if(retweet && parent){
                tweetFormattedHtml = "<div class='media border p-3 " + parent.id + "'><img src='"+ parent.user.profile_image_url +"'" + 
             "alt='' class=\"mr-3 mt-3 rounded-circle\" style=\"width:60px;\"><div class=\"media-body\">" +
            "<span class='text-muted'>Retweet via <a href='"+ username+"'>" + username + "</a> at " + datePosted +"</span><h5><a href='"+ parent.user.url +"'>"+ parent.user.username + "</a><small> Posted on "+ parent.date_posted 
            + "</small></h5><p class='media-content'>" + parent.content 
            + "</p><a href='"+ tweet.id + "/tweet/'>View</a> | <a class='retweetBtn' href='"+ tweet.id 
            + "/retweet/'>Retweet</a> | <a class='tweet-like' href='' data-id='" 
            + tweet.id +"'>"+""+verb+"("+ tweet.likes +")</a></div></div>"

            }  else {
                tweetFormattedHtml = "<div class='media border p-3'><img src='"+ profileImage +"'" + 
             "alt='' class=\"mr-3 mt-3 rounded-circle\" style=\"width:60px;\"><div class=\"media-body\">" +
                "<h5><a href='"+ profileUrl +"'>"+ username + "</a><small> Posted on "
                + datePosted + "</small></h5><p class='media-content'>"
                + tweetContent+"</p><a href='" + tweet.id +"/tweet/'>View</a> | <a class='retweetBtn' href='"
                + tweet.id + "/retweet/'>Retweet</a> | <a class='tweet-like' href='' data-id='" + tweet.id 
                +"'>"+verb+"(" + tweet.likes + ")</a> </div></div>"
            }
             
            if(prepend){
                $("#tweet-container").prepend(tweetFormattedHtml);
            } else {
                $("#tweet-container").append(tweetFormattedHtml);
            }
           
        }

        $("#form").submit(function(event){
            event.preventDefault();
            var formData = $(this).serialize();
            var this_ = $(this);
            $.ajax({
                url:'api/create/',
                data: formData,
                method:'POST',
                success:function(data){
                    this_.find('#tweet-textarea').val("");
                    $("#no-tweet").css("display","none");
                    setTimeout(function(){
                        createTweets(data,true,false);
                        updateHashLinks();
                    },250)
                },
                error:function(error){
                    console.log("error");
                    console.log(error);
                }
            })
        })

        function showNewTweets(){
            console.log("Show New Tweets");
            var oldTweetsLength = oldTweets.length;
            var newTweetsLength = newTweets.length;
            // Getting only latest tweet
            var newTweetItem = newTweets.splice(0,newTweetsLength-oldTweetsLength);
            // oldTweets.forEach((e1)=>newTweets.forEach((e2)=> {if(e1 === e2){
            //     console.log(e1);
            //     console.log(e2);
            //         }
            //     }
            // ));
        }

        setInterval(function fetchLatestTweets(){
            $.ajax({
                url:'api/tweet/',
                method:"GET",
                success:function(data){
                    newTweets = data;
                    showNewTweets();
                },
                error:function(error){
                    console.log("error");
                    console.log(error);
                }
            })
        },3000000);

        function fetchTweets(){
            $.ajax({
                url:'api/tweet/',
                method:"GET",
                success:function(data){
                    console.log(data);
                    oldTweets = data;
                    if(data == 0){
                        $("#no-tweet").css("display","block");
                    } else {
                        $.each(data,function(key,value){
                            if(value.parent){
                                createTweets(value,false,true);
                                updateHashLinks();
                            } else {
                                createTweets(value,false,false);
                                updateHashLinks();
                            }
                            
                        })
                    }
                    
                },
                error:function(error){
                    console.log("error");
                    console.log(error);
                }
            })
        }
        fetchTweets();
    });
</script>
{% endblock style %}